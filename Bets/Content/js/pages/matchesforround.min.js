var MatchesForRoundPage=(function(){var e,d;var c=function(f){this.id=f.matchID;this.firstTeamGoals=ko.observable(f.firstTeamGoals);this.secondTeamGoals=ko.observable(f.secondTeamGoals);this.bonus=ko.observable(parseInt(f.bonus||0))};var b=function(f){var g=this;this.$page=f.$page;this.$row=f.$row;this.$betRow=f.$betRow;this.$btnTrigger=f.$btnTrigger;this.matchViewModel=new c(f);this.savedMatchViewModel=new c(f);this.maxUserBonus=ko.observable(Math.min(parseInt(e)+this.matchViewModel.bonus(),d));this.save=function(){var h=g.$betRow.find(".btn-save").parent();if(g.matchViewModel.firstTeamGoals()==""||g.matchViewModel.secondTeamGoals()==""){g.$betRow.addClass("invalid");return}Utils.blockElement(h,true);AjaxUtils.post({url:g.$page.data("pagetype")+"/Add",json:true,data:ko.toJSON(g.matchViewModel),dataType:"json",success:function(i){e=parseInt(i.UserBonus);g.maxUserBonus(Math.min(g.matchViewModel.bonus()+e,d));if(i.Success===false){g.$betRow.addClass("invalid")}else{g.endEdit()}Utils.unblockElement(h)},error:function(){g.$betRow.addClass("invalid");Utils.unblockElement(h)}})};this.saveOnEnter=function(i,h){if(h.which==13){i.save()}return true};this.endEdit=function(){Utils.unblockElement(g.$betRow.find(".btn-save").parent());g.$betRow.addClass("hide").removeClass("invalid");g.$btnTrigger.removeClass("hide");g.savedMatchViewModel.bonus(g.matchViewModel.bonus());g.savedMatchViewModel.firstTeamGoals(g.matchViewModel.firstTeamGoals());g.savedMatchViewModel.secondTeamGoals(g.matchViewModel.secondTeamGoals());g.$row.find(".bet-warning").replaceWith($("<span>",{html:"&nbsp;-&nbsp;"}))};this.updateBonusPoints=function(){var h=$(this),j=h.data("val"),i=parseInt(g.matchViewModel.bonus()+parseInt(j));if(!i||i<0){i=0}if(i>g.maxUserBonus()){i=g.maxUserBonus()}if(i>d){i=d}g.matchViewModel.bonus(i)}};function a(){var f;d=$("#fld-max-bonus").val();e=$("#UserBonus").val();f=$("#bet-template").html();$("#listing-matchesforcurrentround,#listing-matchesfornextround").delegate(".btn-bet","click",function(){$(".btn-bet").removeClass("hide");$("tr[class*=bet-row]").remove();var j=$(this),i=j.parents("tr:first"),h=j.parents(".listing-page:first");j.addClass("hide");if(i.next().hasClass("hide")){i.next().removeClass("hide");return}var l=i.data("id"),g=$(f).addClass("bet-row-"+l),k;i.after(g);i.addClass("row-"+l);g.find("#Bonus").keyup(function(n){if(n.which==8){return true}var m=$(this),o=parseInt(m.val());if(!o){o=0}else{if(o<0){o=0}else{if(o>k.maxUserBonus()){o=k.maxUserBonus()}}}if(o>d){o=d}m.val(o)});k=new b({$page:h,$betRow:g,$row:i,$btnTrigger:j,matchID:l,firstTeamGoals:i.find(".FirstTeamGoals").text(),secondTeamGoals:i.find(".SecondTeamGoals").text(),bonus:i.find(".Bonus").text()});ko.bindingConventions.conventions({".btn-save":{click:function(n,m){n.save()}},"#FirstTeamGoals":function(m){return{value:m.matchViewModel.firstTeamGoals,event:{keyup:m.saveOnEnter}}},"#SecondTeamGoals":function(m){return{value:m.matchViewModel.secondTeamGoals,event:{keyup:m.saveOnEnter}}},"#Bonus":function(m){return{value:m.matchViewModel.bonus,event:{keyup:m.saveOnEnter}}},".MaxUserBonus":function(m){return{text:m.maxUserBonus}},".btn-bonus":{click:function(n,m){n.updateBonusPoints.call(m.target)}}});ko.applyBindings(k,g[0]);ko.bindingConventions.conventions({".FirstTeamGoals":function(m){return{text:m.firstTeamGoals}},".SecondTeamGoals":function(m){return{text:m.secondTeamGoals}},".Bonus":function(m){return{text:m.bonus}}});ko.applyBindings(k.savedMatchViewModel,i[0]);g.find("#FirstTeamGoals").focus()});Bootstrapper.bindMatchView("MatchesForCurrentRound")}return{init:a}}());$(function(){MatchesForRoundPage.init()});