var ListingPages={};var ListingPage=function(r){this.isLookup=r.isLookup;this.lookup=r.lookup;this.listingType=r.listingType;this.origin=r.origin;this.pageType=null;this.$frmSearchParams=null;this.functions={dataRetrievedCallback:r.dataRetrievedCallback};var c,b,a,d,e,t={pageIndex:0,itemsPerPage:0,keyword:"",advancedFilters:{},sort:{}},q={AllDates:1,Custom:2,ThisWeek:3,LastWeek:4,ThisMonth:5,Today:6,Yesterday:7},s=3,v,k=function(){c.delegate(".pagination","click",function(w){w.preventDefault();t.pageIndex=$(this).data("page-index");v.getContent()});c.delegate("#pager","change",function(){t.itemsPerPage=$(this).val();v.getContent()})},i=function(){var w;c.delegate(".btn-delete","click",function(){w=v.getListingItem($(this));Utils.confirm({message:"Are you sure you want to delete?",callback:function(x){if(!x){return}AjaxUtils.post({blockElement:b,json:true,url:v.listingType+"/Delete",dataType:"json",sendToken:true,data:JSON.stringify($.extend(Utils.getAntiForgeryToken(),v.$frmSearchParams.serializeObject(),{id:w.data("id"),pageType:v.pageType,timeStamp:w.data("timestamp")})),success:function(){v.getContent()}})}})})},n=function(){var w,x;t={pageIndex:c.find(".current-page").val(),itemsPerPage:c.find(".pager").val(),keyword:e.val(),advancedFilters:{},sort:{},searchCriteriaChanged:false};e.bind("keyup",function(y){if(y.which===13){v.getContent();return}if(w){clearTimeout(w)}w=setTimeout(function(){x=$.trim(e.val());if(x.length>=s||y.which==8){t.pageIndex=1;t.keyword=x;t.searchCriteriaChanged=true;v.getContent()}},500)});c.find(".btn-cancel-search").click(function(){if(e.val()!=""){e.val("");t.keyword="";t.pageIndex=1;t.searchCriteriaChanged=true;t.sort={};v.getContent()}})},h=function(){if(a.length==0){return}a.find(":input").each(function(){var x=$(this),y=$(this).val();if(x.is("select")){if(y!=Config.AllItems){t.advancedFilters[this.id]=y}}else{if((this.id=="FromDate"||this.id=="ToDate")&&y!=""){t.advancedFilters[this.id]=Utils.dateToISO(Utils.convertISODateToObject(y))}else{if(y!=""){t.advancedFilters[this.id]=y}}}});var w=c.find(".advanced-filter:first");w.click(function(){c.find(".advanced-search:first").slideToggle("medium");var y=$(this).css("background-image").indexOf("arrow-up")>=0?"arrow-up":"arrow-down",x=(y=="arrow-up")?"arrow-down":"arrow-up";$(this).toggleClass("active").css("background-image",$(this).css("background-image").replace(y,x))});if(w.hasClass("advanced-filter-on")){w.trigger("click")}g();f()},g=function(){a.find("select").change(function(){var w=$(this),x=w.attr("name"),y=w.val();u({$element:w,fieldName:x,value:y});if(w.data("dependency")){return}t.searchCriteriaChanged=true;t.pageIndex=1;v.getContent()})},u=function(C){var E=C.fieldName,F=C.value,x=C.$element,A=x.attr("name")=="DateFilter";if(F===null||F===x.children(":first").attr("value")){delete t.advancedFilters[E];if(A){a.find(".date-field").val("");delete t.advancedFilters.FromDate;delete t.advancedFilters.ToDate}}else{t.advancedFilters[E]=F;if(A){var w=a.find("#FromDate"),y=a.find("#ToDate"),B=Date.today().previous().monday(),D,z;F=parseInt(F,10);switch(F){case q.LastWeek:D=new Date(B).add(-7).days();z=new Date(B).add(-1).days();break;case q.ThisWeek:D=new Date(B);z=new Date(B).add(6).days();break;case q.ThisMonth:D=Date.today().clearTime().moveToFirstDayOfMonth();z=Date.today().clearTime().moveToLastDayOfMonth();break;case q.Today:D=Date.today();z=Date.today().addDays(1).addSeconds(-1);break;case q.Yesterday:D=Date.today().addDays(-1);z=Date.today().addSeconds(-1);break;default:D=null;z=null}if(D!=null){w.datepicker("setDate",D);y.datepicker("setDate",z);t.advancedFilters.FromDate=Utils.dateToISO(D);t.advancedFilters.ToDate=Utils.dateToISO(z)}}}},f=function(){a.find(".date-field").each(function(){var w=$(this);Utils.addDateField(this);w.change(function(){var x=a.find("#FromDate"),y=a.find("#ToDate"),z=x.val(),A=y.val();if(z!=""&&A!=""){z=x.datepicker("getDate");A=y.datepicker("getDate");t.advancedFilters.FromDate=Utils.dateToISO(z);t.advancedFilters.ToDate=Utils.dateToISO(A);$("[name=DateFilter]").val(q.Custom);t.advancedFilters.DateFilter=q.Custom;t.searchCriteriaChanged=true;t.pageIndex=1;v.getContent()}})})},l=function(){c.find(".btn-save-search:first").click(function(){Utils.confirm({message:"Save this Search:",hasInput:true,callback:function(w,x){if(!w){return}AjaxUtils.post({blockElement:a,json:true,url:"User/AddSavedSearch",dataType:"json",data:JSON.stringify({name:x,pageType:v.pageType,keyword:t.keyword,advancedFilters:JSON.stringify(t.advancedFilters)}),success:function(){}})}})});c.find(".btn-show-searches:first").click(function(){AjaxUtils.get({url:"User/GetSavedSearches",data:{pageType:v.pageType},success:function(w){Utils.modal({content:w,onClosed:function(){},onComplete:m})}})});c.find(".btn-clear-filters").click(function(){t.advancedFilters={};var w=a.find(":input"),x=w.filter("[data-dependency]");if(x.length===0){w.val(Config.AllItems);v.getContent()}else{$(x[0]).val(Config.AllItems).change()}})},m=function(){var w=$("#modal-saved-searches ul");w.delegate("li","click",function(z){var y=$(z.target),x=y.is("li")?y:y.parents("li:first"),A=x.data("id");if(y.hasClass("btn-delete")){AjaxUtils.post({blockElement:w,url:"User/DeleteSavedSearch",data:{id:A},success:function(){x.remove()}})}else{AjaxUtils.post({blockElement:w,url:"User/SelectSavedSearch",data:{id:A,pageType:v.pageType},dataType:"json",success:function(D){var C;D.AdvancedFilters=JSON.parse(D.AdvancedFilters);a.find(":input").val(Config.AllItems);$("[data-dependenton]").attr("disabled","disabled");t.advancedFilters={};for(var E in D.AdvancedFilters){var B=a.find("[name="+E+"]");if(E=="FromDate"||E=="ToDate"){B.datepicker("setDate",Utils.convertISODateToObject(D.AdvancedFilters[E]))}else{if(B.data("dependency")&&!B.data("dependenton")){C=B}else{if(B.data("dependenton")){if(!B.hasEvent("reloaded")){B.bind("reloaded",function(){var F=$(this);F.removeAttr("disabled");F.val(D.AdvancedFilters[F.attr("name")]).change()})}}else{B.val(D.AdvancedFilters[E])}}}t.advancedFilters[E]=D.AdvancedFilters[E]}t.keyword=D.Keyword;e.val(D.Keyword);if(C){C.val(D.AdvancedFilters[C.attr("name")]).change()}else{v.getContent()}Utils.closeModal()}})}})},p=function(){if(v.isLookup){return}var w=d.find("th");w.click(function(){var x=$(this),z=x.data("col"),y=!x.hasClass("desc");if(!z){return}t.sort={Column:z,Asc:!y};v.getContent();w.removeClass("sorted");x.addClass("sorted")})},o=function(){b.find(".select-all").change(function(){var w=$(this).attr("checked")||false;d.find(".action > input").attr("checked",w)})},j=function(){var w;c.find("[data-lookup]").click(function(){w=$(this);var z=w.data("selectall"),y={};y[w.data("field")]=w.data("id");if(z===undefined){z=true}var x=new LookupPage({parent:v,multipleAdd:true,selectAll:z,listingType:w.data("lookup"),pageType:w.data("pagetype"),searchParams:$.extend(v.$frmSearchParams.serializeObject(),y),onComplete:function(){EventManager.trigger(EventManager.Event.LookupReload,v.pageType,x)},addCallback:function(A,B){}});x.show()})};this.getData=function(w){AjaxUtils.post({json:true,url:v.listingType+"/"+w.type,data:JSON.stringify($.extend(w.params,{model:v.$frmSearchParams.serializeObject(),pageType:v.pageType,pageIndex:t.pageIndex,itemsPerPage:t.itemsPerPage,keyword:t.keyword,searchCriteriaChanged:t.searchCriteriaChanged,advancedFilters:JSON.stringify(t.advancedFilters),sort:t.sort,isLookup:v.isLookup,origin:v.origin})),dataType:w.json?"json":"text",blockElement:b,success:function(x){w.callback(x)}})};this.getContent=function(){v.getData({type:"GetListing",callback:function(w){t.searchCriteriaChanged=false;b.html(w);d=c.find(".listing-table:first");p();o();t.pageIndex=c.find(".current-page").val();if(v.functions.dataRetrievedCallback){v.functions.dataRetrievedCallback()}if(v.lookup){EventManager.trigger(EventManager.Event.LookupReload,v.pageType,v.lookup)}else{EventManager.trigger(EventManager.Event.ListingReload,v.pageType,v.lookup)}}})};this.init=function(){v=this;c=v.isLookup?$("#lookup-"+v.listingType):$("[data-listingtype="+v.listingType+"]:first");v.pageType=c.data("pagetype");ListingPages[v.listingType]=this;v.$frmSearchParams=c.find(".frm-search:first");d=c.find(".listing-table:first");b=c.find(".listing-items:first");a=c.find(".advanced-search:first");e=c.find(".txt-listing-search");k();i();n();h();CRUD.bindDependentDropdowns(a,v.listingType,CRUD.PageMode.List);l();p();o();if(!v.isLookup){j()}};this.reload=function(){this.getContent()};this.getListingItem=function(w){if(v.isLookup){if(w.hasClass("listing-item")){return w}return w.parents(".listing-item")}else{if(w.data("id")){return w}return w.parents(".listing-item")}};this.getListingItemID=function(x){var w=v.getListingItem(x);return w.data("id")};this.getListingItemIDs=function(x,w){this.getData({json:true,type:"GetDataIDs",callback:w,params:{excludedIDs:x}})};this.moveToNextPage=function(){t.pageIndex+=1;this.reload()};this.moveToPrevPage=function(){t.pageIndex+=1;this.reload()}};$(function(){$("[name=fld-listing-type]").each(function(){var a=new ListingPage({listingType:$(this).val()});a.init()})});