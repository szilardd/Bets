var LookupPage=function(a){var b=this;this.parent=a.parent;this.listingType=a.listingType;this.pageType=a.pageType;this.origin=a.origin;this.pageID="lookup-"+a.listingType;this.searchParams=typeof(a.searchParams)==="function"?a.searchParams():a.searchParams;this.$page=null;this.listing=null;this.functions={addCallback:a.addCallback,onComplete:a.onComplete};this.multipleAdd=a.multipleAdd||false;this.selectAll=a.selectAll||false;this.customAdd=a.customAdd||false;this.selectAllMode=false;this.removeMode=false;this.selectedIDs=[];this.removedIDs=[];this.selectedNames=[];this.nrOfSelectedIDs=0;this.totalNrOfIDs=0;this.init=function(){this.selectedIDs=[];this.removedIDs=[];this.selectedNames=[];if(a.data&&a.data.ids){this.selectedIDs=a.data.ids;this.selectedNames=a.data.names}};this.show=function(){b.getModalContent(function(c){b.displayModal(c)})};this.getModalContent=function(c){AjaxUtils.post({json:true,url:b.listingType,data:JSON.stringify({isLookup:true,pageType:b.pageType,model:b.searchParams,origin:b.origin}),blockElement:$("body"),success:function(d){b.displayModal(d)}})};this.displayModal=function(d,c){Utils.modal({content:d,onComplete:function(){if(c){c()}else{b.bindModal()}b.dataRetrievedCallback();if(b.functions.onComplete){b.functions.onComplete()}},onClosed:function(){EventManager.trigger(EventManager.Event.LookupClose,b.pageType)}})};this.bindModal=function(){b.$page=$("#"+b.pageID);if(b.selectAll){b.$page.addClass("lookup-multiple")}b.bindUI();b.listing=new ListingPage({listingType:b.listingType,origin:b.origin,isLookup:true,dataRetrievedCallback:b.dataRetrievedCallback,lookup:this});b.listing.init()};this.close=function(){$.fancybox.close()};this.bindUI=function(){var e,d,c,g,f,h;b.$page.delegate(".listing-item:not(.selected-item), .btn-lookup-add","click",function(j){j.stopPropagation();e=$(this);if(e.hasClass("listing-item")){c=e.find(".btn-lookup-add");d=e}else{c=e;d=e.parents(".listing-item:first")}h=d.find(".listing-item-name").text();g=d.data("id");if(b.multipleAdd){if(b.selectAllMode){f=b.selectedIDs.indexOf(g);if(f>=0){b.selectedIDs.splice(f,1);b.nrOfSelectedIDs+=1;b.setCount()}}else{if(b.removeMode){f=b.removedIDs.indexOf(g);if(f>=0){b.removedIDs.splice(f,1)}else{b.selectedIDs.push(g);b.selectedNames.push(h)}}else{b.selectedIDs.push(g);b.selectedNames.push(h)}}b.toggleButtonState.call(c,false,g)}else{var i=d.find(".frm-extra-data"),k={};if(i.length==1){k=i.serializeObject()}b.functions.addCallback(g,h,k);b.close();EventManager.trigger(EventManager.Event.LookupAdd,b.pageType,{itemID:g,name:h,extraData:k})}});if(b.multipleAdd){b.bindMultipleAdd()}};this.bindMultipleAdd=function(){var e,d,c,g,f;b.$page.delegate(".selected-item, .btn-lookup-remove","click",function(h){h.stopPropagation();var i;e=$(this);if(e.hasClass("listing-item")){c=e.find(".btn-lookup-remove");d=e}else{c=e;d=e.parents(".listing-item:first")}g=d.data("id");if(b.selectAllMode){b.selectedIDs.push(g);b.nrOfSelectedIDs-=1;b.setCount()}else{i=b.selectedIDs.indexOf(g);if(b.removeMode){if(i<0){b.removedIDs.push(g)}else{b.selectedIDs.splice(i,1);b.selectedNames.splice(i,1)}}else{b.selectedIDs.splice(i,1);b.selectedNames.splice(i,1)}}b.toggleButtonState.call(c,true,g)});b.$page.find(".btn-add-all").removeClass("removed").click(function(){e=$(this);if(b.selectedIDs.length==0&&b.removedIDs.length==0&&!b.selectAllMode){return}e.addClass("removed");if(b.selectAllMode){b.listing.getListingItemIDs(b.selectedIDs,function(j){b.selectedIDs=j;b.saveMultiple(b.selectedIDs)})}else{if(b.customAdd){b.functions.addCallback(b.selectedIDs,b.selectedNames);b.close()}else{var h=function(j){b.saveMultiple(j)};var i=EventManager.trigger(EventManager.Event.LookupAdd,b.pageType,b.selectedIDs,h);if(!i){b.saveMultiple(b.selectedIDs)}}}});if(!b.customAdd){b.bindSelectAll()}};this.bindSelectAll=function(){var c,e,d;b.$page.delegate(".btn-select-all","click",function(){var f=$(this);b.selectAllMode=true;b.selectedIDs=[];b.toggleSelectAllButtonState.call(f);b.$page.find(".btn-lookup-add").click();b.nrOfSelectedIDs=b.getTotalCount();b.totalNrOfIDs=b.nrOfSelectedIDs;b.setCount();b.$page.find("#listing-count-container").toggleClass("removed")});b.$page.delegate(".btn-remove-all","click",function(){var f=$(this);b.selectAllMode=false;b.selectedIDs=[];b.toggleSelectAllButtonState.call(f);b.$page.find(".btn-lookup-remove").click();b.$page.find("#listing-count-container").toggleClass("removed")})};this.saveMultiple=function(c){var d={ids:c,model:b.searchParams};if(b.removeMode){d.removedIDs=b.removedIDs}AjaxUtils.post({json:true,dataType:"json",url:b.listingType+"/Add"+b.pageType,data:JSON.stringify(d),blockElement:$("body"),success:function(e){if(b.parent){b.parent.reload()}b.close()}})};this.dataRetrievedCallback=function(){var e,g,f,d=b.$page.find(".listing-items tbody .button-action");if(b.selectAll){var c=b.$page.find(".btn-select-all");c.removeClass("removed");if(b.selectAllMode){b.toggleSelectAllButtonState.call(c)}}if(b.selectAllMode){var h=b.getTotalCount();if(h!=b.totalNrOfIDs){b.nrOfSelectedIDs=h;b.totalNrOfIDs=b.nrOfSelectedIDs;b.selectedIDs=[]}b.$page.find("#listing-count-container").removeClass("removed");b.setCount()}if(b.selectedIDs.length>0){d.each(function(){e=$(this);g=b.listing.getListingItemID(e);index=b.selectedIDs.indexOf(g);if(index>=0){if(b.selectAllMode){b.toggleButtonState.call(e,true,g)}else{b.toggleButtonState.call(e,false,g)}}else{if(b.selectAllMode){b.toggleButtonState.call(e,false,g)}}})}else{if(b.selectAllMode){d.each(function(){var i=$(this);g=b.listing.getListingItemID(i);b.toggleButtonState.call($(this),false,g)})}}};this.toggleButtonState=function(e,d){var c=this.parents(".listing-item:first");if(this.hasClass("btn-lookup-remove")||e===true){this.removeClass("btn-lookup-remove").addClass("btn-lookup-add").text("Select");c.removeClass("selected-item")}else{if(this.hasClass("btn-lookup-add")||e===false){this.removeClass("btn-lookup-add").addClass("btn-lookup-remove").text("Remove");c.addClass("selected-item")}}EventManager.trigger(EventManager.Event.LookupItemStateChange,b.pageType,{toRemovedState:e,itemID:d})};this.toggleSelectAllButtonState=function(){if(this.hasClass("btn-select-all")){this.removeClass("btn-select-all").addClass("btn-remove-all").text("Remove All")}else{this.removeClass("btn-remove-all").addClass("btn-select-all").text("Select All")}};this.removeItem=function(d){var c=b.$page.find("[data-id="+d+"] .btn-lookup-remove");if(c.length){b.toggleButtonState.call(c)}};this.setCount=function(){b.$page.find("#listing-count").text(b.nrOfSelectedIDs)};this.getTotalCount=function(){return parseInt($("#fld-total-count").val())};this.setRemoveMode=function(c){b.removeMode=c;if(c){b.$page.find(".btn-add-all").text("Save All")}};this.init()};